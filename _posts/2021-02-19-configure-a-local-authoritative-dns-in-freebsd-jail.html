---
layout: post
title: Configure a local authoritative DNS in FreeBSD Jail
canonical_url: https://medium.com/@charliemaiors/configure-a-local-authoritative-dns-in-freebsd-jail-f0ed96d3825c?source=rss-7412c234d1fc------2
tag:
- bind9
- freebsd
- dns
- jail
---

<p>Since when I installed my FreeBSD box I’ve tried a lot of different services/servers, and each one of them is <a href="https://www.freebsd.org/doc/handbook/jails.html">jailed</a>.<br> Starting with a simple VPN service based on OpenVPN, till a “local-authoritative” DNS server; which could be useful in a home environment, typically statically served in terms of IP allocation.</p><h3>Environment preparation</h3><p>First of all a new jail must be settled up (see the <a href="https://www.carlomaiorano.me/freebsd/2019/02/18/openvpn-freebsd-jail.html">Define Jail</a> part of the OpenVPN post), then we can proceed to the jail initialization and configuration.<br> You can find some hints on the <a href="https://www.carlomaiorano.me/freebsd/2019/02/18/openvpn-freebsd-jail.html">OpenVPN guide</a> to set up the jail, then we have to connect to it and bootstrap all the necessary systems. First of all, we have to connect to the already defined jail using jexec &lt;jail-name&gt; tcsh, then we have to bootstrap the package manager pkg bootstrap &amp;&amp; pkg upgrade -y and then we can start to install packages.<br> I&#39;ve used it as a DNS server because is the most reliable and RFC-compliant DNS server nowadays, and also is the most well-documented and *nix compliant server.<br> We have to install the bind9 package using: pkg install -y bind9, then we have to enable it in /usr/local/etc/rc.conf manually (or using echo &#39;named_enable=&quot;YES&quot;&#39; &gt;&gt; /usr/local/etc/rc.conf), or delegating to the sysrc system tool running sysrc named_enable=&quot;YES&quot;.</p><h3>DNS Configuration</h3><p>The DNS server configuration is not complicated, we have to edit the configuration file, and then we have to define our zone files. The configuration must be made, as always, inside the appropriate jail.<br> We have to edit the named configuration file which is located in /usr/local/etc/namedb/named.conf like this:</p><pre>acl goodclients { # A list of &quot;good clients&quot; in terms of which networks are allowed to query the DNS server<br> 192.168.1.0/24; # My local network<br> 192.168.177.0/24; # My jail network<br> 192.168.188.0/24; # My vm network<br> localhost;<br> localnets;<br>};<br>options{<br>...<br>  listen-on { 127.0.0.1; &lt;your-jail-ip&gt;; };<br> notify yes;<br> recursion yes;<br>  allow-recursion { goodclients; };<br> forwarders { # We want to forward each unknown request to other dns services<br>  8.8.8.8; <br>  8.8.4.4;<br> };<br> ...<br>}</pre><p>Then we have to define our zones, first of all, we have to add them to the configuration file:</p><pre>...<br>options{ <br>    ...<br>}<br>...<br>zone &lt;your-zone-name&gt; {<br>    type master; <br>    file &quot;/usr/local/etc/namedb/master/&lt;zone-file-name&gt;&quot;;<br>    allow-transfer { none; };<br>}<br>zone &quot;1.168.192.in-addr.arpa&quot; {<br>    type master;<br>    file &quot;/usr/local/etc/namedb/master/db.rev.192&quot;;<br>    allow-transfer { none; };<br>};</pre><p>The above snippet shows how to configure a standard DNS zone with the respective <a href="https://www.wikiwand.com/en/Reverse_DNS_lookup">reverse zone</a>.<br> Now we have to define our DNS zone file and the reverse one in the path defined in the configuration file. A zone file looks like this:</p><pre>$TTL    604800<br>&lt;zone-name&gt;. SOA   ns1.&lt;zone-name&gt;.       root.&lt;zone-name&gt;. (<br>                        2018101901;     Serial<br>                        3H;             Refresh<br>                        15M;            Retry<br>                        2W;             Expiry/                    1D );           Minimum<br>; name servers - NS records<br>        IN      NS      &lt;zone-name&gt;.<br><br>; name servers - A records<br>&lt;zone-name&gt;.unx.       IN      A       &lt;server-ip&gt;<br><br>record1.&lt;zone-name&gt;.     IN      A       &lt;record1-ip&gt;<br>record2.&lt;zone-name&gt;.     IN      A       &lt;record2-ip&gt;</pre><p>Instead, a reverse zone file is like this:</p><pre>; BIND reverse data file.<br>; The domain, etc. used should be a listed &#39;zone&#39; in named.conf. <br><br>$TTL 86400<br>1.168.192.in-addr.arpa.   IN SOA      ns1.&lt;zone-name&gt;.       root.&lt;zone-name&gt;. (<br>                2018040501  ; Serial<br>                10800       ; Refresh<br>                3600        ; Retry<br>                604800      ; Expire<br>                86400 )     ; Minimum<br><br>; In this case, the number just before &quot;PTR&quot; is the last octet <br>; of the IP address for the device to map (e.g. 192.168.56.[3])<br><br>; Name Servers<br>       IN NS   ns1.&lt;zone-name&gt;.<br><br>; Reverse PTR Records<br>&lt;last-octet-of-the-ip-address-of-the-server&gt;       IN PTR  ns1.&lt;zone-name&gt;.   <br>&lt;last-octet-of-the-ip-address-of-the-record1&gt;        IN PTR  record1.&lt;zone-name&gt;. <br>&lt;last-octet-of-the-ip-address-of-the-record2&gt;       IN PTR  record2.&lt;zone-name&gt;.</pre><p>These files are the basic configuration for a DNS server exposed on a 192.168.1.0/24 network, but, as is visible from the first part of the configuration, there are multiple networks and services like the HTTP server, and also intra-jail services (and of course I want to experiment!!!) which could require different views of the same zone; so I’ve modified the configuration and settled up two different views: one for the normal local network, and one for the jail networks.<br> The configuration file must be modified like this:</p><pre>...<br>acl jails {<br>    192.168.177.0/24 # my jail network<br>}<br>options {<br>    ...<br>}<br><br>view &quot;jails&quot; {<br>    match-clients { jails; };<br>    # Insert each zone from the original config files which are not interested<br>    zone &quot;masinihouse.unx&quot; {<br>        type master;<br>        file &quot;/usr/local/etc/namedb/master/&lt;your-jail-related-db&gt;&quot;;<br>        allow_transfer {none;};<br>    }<br><br>    zone &quot;1.168.192.in-addr.arpa&quot; {<br>        type master;<br>        file &quot;/usr/local/etc/namedb/master/db.rev.192&quot;;<br>        allow_transfer {none;};<br>    }<br><br>    zone &quot;177.168.192.in-addr.arpa&quot; {<br>        type master;<br>        file &quot;/usr/local/etc/namedb/master/db.rev.177&quot;;<br>        allow_transfer {none;};<br>    }<br>}</pre><p>The only difference is that you have to specify the selected reverse zones and create an ACL for the view, also a separate database file with different records.</p><p>After the configuration runs the rndc reload command to reload the configuration of the DNS server, if is an &quot;intermediate&quot; configuration try to invalidate the DNS cache on your machine.</p><p><strong>Note:</strong> each zone has allow_transfer settled to none because this is the only DNS server on my network, if there is another DNS server (maybe a slave DNS server) the allow_transfer must include the subnet or the specific IP address of the other DNS server record (NS record type).</p><h3>Jail and Server Configuration</h3><p>We want to install a local-authoritative DNS server so we have to configure the firewall and then each jail to rely on the newest DNS server.<br> First of all, we have to define the services on the firewall (bind is the name of my jail):</p><pre>...<br>ext_if = &quot;&lt;you-public-iface&gt;&quot;<br>bind_jail_ip = &quot;&lt;your-jail-ip&gt;&quot;<br>bind_jail_udp = &quot;{ rndc, domain }&quot;<br>bind_jail_tcp = &quot;{ domain }&quot;<br>....<br>rdr pass on $ext_if inet proto udp to port $bind_jail_udp -&gt; $bind_jail_ip<br>rdr pass on $ext_if inet proto tcp to port $bind_jail_tcp -&gt; $bind_jail_ip</pre><p>Then we have to instruct each jail, the hosting machine, and each machine on the same network to use the defined DNS server. To do it you have to configure it in /etc/resolv.conf the IP address of the jail/server depending on what device are you configuring (of course for Windows or Mac the configuration method is different). For example, in a jail, you have to define the resolv.conf file like this:</p><pre>search &lt;your-base-domain&gt;<br>nameserver &lt;nameserver-jail-ip&gt;<br>nameserver &lt;another-fallback-dns&gt;</pre><p>Instead for the hosting server, you have to configure the resolv.conf file like this:</p><pre>search &lt;your-base-domain&gt;<br>nameserver 127.0.0.1<br>nameserver &lt;another-fallback-dns&gt;</pre><p>Then for another machine in your local area network:</p><pre>search &lt;your-base-domain&gt;<br>nameserver &lt;server-ip&gt;<br>nameserver &lt;another-fallback-dns&gt;</pre><h3>Conclusions</h3><p>Bind9 is a battle-tested and rock-solid DNS server, the configuration is pretty easy and fits perfectly for a home environment. BTW it does not have a feasible GUI, which could be a plus, but with some scripts or at least a playbook, the configuration could be fully automated.</p><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=f0ed96d3825c" width="1" height="1" alt="">
