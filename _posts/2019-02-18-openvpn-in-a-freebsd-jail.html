---
layout: post
title: OpenVPN in a FreeBSD Jail
canonical_url: https://medium.com/@charliemaiors/openvpn-in-a-freebsd-jail-c6c87ed7dc88?source=rss-7412c234d1fc------2
tag:
- freebsd
- vpn
- jail
- homelab
- openvpn
---

<p>FreeBSD <a href="https://www.freebsd.org/doc/handbook/jails.html">Jails</a> are the first examples of containerization with <a href="https://www.wikiwand.com/en/Solaris_Containers">Solaris Zones</a>, followed by Docker, rkt, <a href="https://wiki.archlinux.org/index.php/systemd-nspawn">Systemd-nspawn</a>, and other <a href="https://www.opencontainers.org">OCI</a> implementations. The jails, IMHO, are the most effective and useful (with systemd-nspawn on the Linux side) containerization technologies, because they allow having daemons and more than one process per container relying on services (or systemd services), system providing automation and isolation at the same time. A good usage of jails could be a VPN service, which is very sensitive and could compromise an entire system if it is hijacked. In this article, we will define a jail with OpenVPN.</p><h3>Define jail</h3><p>There are several methods to create a new jail:</p><ul><li>Using base system archives, or building from source, as explained in the <a href="https://www.freebsd.org/doc/handbook/jails-build.html">handbook</a></li><li>Using a base jail and expanding from it (also using VTNET for FreeBSD &lt; 12.0) as explained in <a href="https://www.cyberciti.biz/faq/how-to-configure-a-freebsd-jail-with-vnet-and-zfs/">nixcraft</a></li><li>Using ezjail, always from the <a href="https://www.freebsd.org/doc/handbook/jails-ezjail.html">handbook</a>;</li><li>Using <a href="https://github.com/iocage/iocage">iocage</a>, a newer jail handler written in Python;</li></ul><p>I prefer using src method and compile the base system (and also the kernel) in order to have a userland synced with the kernel. In order to have a new jail, I will (assuming that you have already in place networking, firewal,l and jail configuration file):</p><ul><li>Create the directory (use also a different ZFS dataset or even pool with a given mountpoint) mkdir &lt;jail-root&gt;/&lt;new-jail-name&gt;</li><li>Install the new jail setenv D &lt;path-to-jail&gt;, then run make installworld DESTDIR=$D and make distribution DESTDIR=$D</li><li>Add your new defined jail to your jail configuration file</li><li>Run it service jail start &lt;jail-name&gt;</li></ul><h3>Extra Jail configuration for OpenVPN</h3><p>OpenVPN in a jail requires extra configuration to work, because it uses a tun device for network routing:</p><ul><li>Create a tun device on the host, this can be done in two ways:</li><li>Add to rc.conf cloned_interfaces=&quot;tun&quot; (or simply add tun if you already have a cloned interface), ifconfig_tun=&quot;10.8.0.0/24&quot; and restart the network and routing service ```service netif restart &amp;&amp; service routing restart``</li><li>Run ifconfig tun create (the output will be tun0), ifconfig tun0 inet 10.8.0.2 10.8.0.1 netmask 255.255.255.0 and ifconfig tun0 up</li><li>Create a devfs ruleset for the jail, mine is:</li></ul><pre>[devfsrules_jail_vpn=5]<br>add include $devfsrules_hide_all<br>add include $devfsrules_unhide_basic<br>add include $devfsrules_unhide_login<br>add path &#39;tun*&#39; unhide<br>add path zfs unhide</pre><ul><li>Apply the ruleset to your jail section, plus a network configuration for the tun device in the jail configuration file, this is a snippet of my file:</li></ul><pre>...  <br>devfs_ruleset = &quot;5&quot;;<br>ip4.addr += &quot;tun0|10.8.0.1 10.8.0.2 netmask 255.255.255.0&quot;;<br>exec.prestart = &quot;route add -net 10.8.0.0/24 10.8.0.2&quot;;<br>...</pre><ul><li>Configure your firewall, ipfw or pf, to forward the OpenVPN port to the jail and handle the tun interface, I’ve used pf:</li></ul><pre>ext_if=&quot;em0&quot;<br>tun_if=&quot;tun0&quot;<br>openvpn_jail_ip = &quot;&lt;jail-ip&gt;&quot;<br>...<br>tun_net=&quot;10.8.0.0/24&quot;<br>...<br>openvpn_jail_udp = &quot;{ openvpn }&quot; # is in /etc/services<br>nat on $ext_if from $tun_net to any -&gt; $ext_if<br>...<br>pass quick on $tun_if<br>...</pre><ul><li>Then reload your firewall (if needed)</li></ul><h3>Configure the Jail</h3><p>After this preliminary configuration, we can work with the jail running jls to find which is the JID of the OpenVPN jail, then run jexec &lt;jid&gt; tcsh. Inside the jail run:</p><ul><li>pkg bootstrapto bootstrap the pkg service and install OpenVPN from that, or portsnap fetch extract If you want to use ports.</li><li>Install (or compile) OpenVPN: pkg install -y openvpnThis will also install easyrsa</li><li>Copy the easy-rsa folder inside the OpenVPN folder running: cp -r /usr/local/share/easy-rsa /usr/local/etc/openvpn/easy-rsa and move into it cd /usr/local/etc/openvpn/easy-rsa</li></ul><p>Now we will define our Certification Authority using easyrsa. You can replace the usage of the easyrsa executable inside the copied folder with the one available system-wide setting the variable setenv EASYRSA=/usr/local/etc/openvpn/easy-rsa. The steps needed to create the PKI are:</p><ul><li>Edit the vars file for default values according to your organization:</li></ul><pre>set_var EASYRSA_REQ_COUNTRY     &quot;Whatever&quot;<br>set_var EASYRSA_REQ_PROVINCE    &quot;Whatever&quot;<br>set_var EASYRSA_REQ_CITY        &quot;Whatever&quot;<br>set_var EASYRSA_REQ_ORG         &quot;Whatever&quot;<br>set_var EASYRSA_REQ_EMAIL       &quot;Whatever@Whatever.com&quot;<br>set_var EASYRSA_REQ_OU          &quot;Nobody&quot;<br>  <br>set_var EASYRSA_KEY_SIZE        384 (or 2048/4096 in   case of RSA)<br>  <br>set_var EASYRSA_ALGO            ec (could be also rsa)<br>set_var EASYRSA_CURVE           secp384r1 (only in   case of EASYRSA_ALGO=ec)<br>  <br>set_var EASYRSA_CA_EXPIRE       3650</pre><ul><li>The create the Public Key Infrastructure (PKI): /easyrsa.real init-pki</li><li>Build your ca: ./easyrsa.real build-ca</li><li>Build the server certificate: ./easyrsa.real build-server-full server nopass</li><li>Generate the Diffie-Hellman params: ./easyrsa.real gen-dh</li><li>Generate the OpenVPN TLS Authentication key: openvpn --genkey --secret ta.key</li></ul><p>Now we will configure the OpenVPN server:</p><ul><li>Copy the sample configuration for the OpenVPN server: cp /usr/local/share/examples/openvpn/sample-config-files/server.conf /usr/local/etc/openvpn/server.conf</li><li>Edit the file, in particular, add (or replace):</li></ul><pre>...<br>dev tun0<br>ca /usr/local/etc/openvpn/easy-rsa/pki/ca.crt<br>cert /usr/local/etc/openvpn/easy-rsa/pki/issued/server.crt  <br>key /usr/local/etc/openvpn/easy-rsa/pki/private/server.key  # This file should be kept secret<br>dh /usr/local/etc/openvpn/easy-rsa/pki/dh.pem<br>...<br>push &quot;route &lt;physical-net&gt; 255.255.255.0&quot;<br>...<br>push &quot;redirect-gateway def1 bypass-dhcp&quot; # if you want to use the VPN for traffic redirecting<br>push &quot;dhcp-option DNS 8.8.8.8&quot; # DNS 1<br>push &quot;dhcp-option DNS 8.8.4.4&quot; # DNS 2<br>tls-auth /usr/local/etc/openvpn/easy-rsa/ta.key 0 # This file is secret<br>ifconfig-noexec # to avoid tun reconfiguration which will cause a failure</pre><ul><li>Enable the service and configure it by adding in /etc/rc.conf The following lines:</li></ul><pre>openvpn_enable=&quot;YES&quot;<br>openvpn_if=&quot;tun&quot;<br>openvpn_configfile=&quot;/usr/local/etc/openvpn/server.conf&quot;<br>openvpn_dir=&quot;/usr/local/etc/openvpn/&quot;</pre><ul><li>Run the service service openvpn start (NOTE: If it fails, run on the host system ifconfig tun0 inet 10.8.0.2 10.8.0.1 only for the first time)</li><li>Generate the client credentials, I’ve created a set of scripts to create the base configuration and then generate each client OVPN file. You can clone the running: git clone <a href="https://bitbucket.org/cmaiorano/openvpn-client-generator.git">https://bitbucket.org/cmaiorano/openvpn-client-generator.git</a></li><li>Move into directory: cd openvpn-client-generator/</li><li>Run ./generate-base-conf.sh for the first time, then for each client run ./generate-client.sh &lt;client-name&gt;.</li><li>You can also revoke a client certificate running ./revoke-client.sh, it will also generate a CRL and add it to your OpenVPN server configuration, then you have to reload the service.</li></ul><p>Now, if everything went right, you can enjoy your OpenVPN server inside a FreeBSD jail.</p><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=c6c87ed7dc88" width="1" height="1" alt="">
