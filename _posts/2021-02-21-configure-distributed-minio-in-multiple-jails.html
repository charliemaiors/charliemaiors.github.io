---
layout: post
title: Configure distributed Minio in multiple jails
canonical_url: https://medium.com/@charliemaiors/configure-distributed-minio-in-multiple-jails-0ead26237556?source=rss-7412c234d1fc------2
tag:
- freebsd
- jail
- ha
- minio
---

<p>In the last period I’ve done a lot of experiments, on my FreeBSD-powered nuc, like configuring the <a href="https://www.carlomaiorano.me/freebsd/2021/02/19/dns-freebsd-jail.html">DNS server</a>, deploying Homeassistant (I will also write about it), installing nginx-plus (I will also write an article on how to obtain a development/home license), and last but not least deploy a <a href="https://docs.min.io/docs/distributed-minio-quickstart-guide.html">Minio cluster</a>.<br> Ok, a Minio cluster on a single machine probably does not make any sense but I want to try how to configure it to understand it works.<br> <a href="https://min.io/">MinIO</a> is an implementation of the s3 API, which is a standard de facto for object storage APIs, highly scalable and resilient. It allows also to host a static website or a dynamic one if the framework allows it (for instance <a href="https://medium.com/employbl/host-a-vue-js-website-on-amazon-s3-for-the-best-hosting-solution-ever-%EF%B8%8F-eee2a28b2506">vuejs</a>).</p><h3>Configure the environment</h3><p>Minio for distributed deployment requires at least 4 drives up and running distributed among any number of replicas, in my deployment, I’ve one drive per replica.<br> After the deployment of four different jails (see the Define Jail section in this <a href="https://www.carlomaiorano.me/freebsd/2019/02/18/openvpn-freebsd-jail.html">article</a>), you have also to allocate space for the jails using the ZFS dataset or whatever you prefer; for instance, I’ve settled up a different dataset from each Zpool and mounted in each jail on the /data path, to achieve this a dataset in a pool must be created running zfs create -o mountpoint=/mnt/minio-{1,2,3,4} &lt;zpool&gt;/&lt;dataset&gt; and then mapped to the relative jail fstab:</p><pre>/usr/ports                              /jails/&lt;jail&gt;/usr/ports                 nullfs          rw              0       0<br>/mnt/minio-{1,2,3,4}                   /jails/&lt;jail&gt;/data               nullfs          rw              0       0</pre><p>After you have to install MinIO in each of them, for instance (assuming that each jail is called Minio-x, where x is a number):</p><pre># Assuming that you are using tcsh<br>foreach jail `jls -v name | grep minio*`<br>    jexec $jail pkg bootstrap; pkg upgrade -y; pkg install -y minio;<br>end</pre><p>Then you have either to put each jail IP in the /etc/hosts with a symbolic name or register each jail ip in the DNS (look also to the guide on <a href="https://www.carlomaiorano.me/freebsd/2021/02/19/dns-freebsd-jail.html">How to deploy a jailed DNS server</a>).<br> Now we can configure and run the MinIO service on each jail, I will explain the procedure for just one but they must be repeated for each jail (or even node if you are running a <em>true</em> distributed setup).<br> First of all, we have to enable the Minio services in/etc/rc.conf plus other variables to configure the running services:</p><pre>minio_enable=&quot;YES&quot;<br>minio_disks=&quot;http://&lt;dns-or-ip&gt;:&lt;port&gt;/&lt;path-to-minio-folder&gt; http://&lt;dns-or-ip&gt;:&lt;port&gt;/&lt;path-to-minio-folder&gt; http://&lt;dns-or-ip&gt;:&lt;port&gt;/&lt;path-to-minio-folder&gt; http://&lt;dns-or-ip&gt;:&lt;port&gt;/&lt;path-to-minio-folder&gt;&quot;<br>minio_env=&quot;MINIO_ACCESS_KEY=&lt;access-key&gt; MINIO_SECRET_KEY=&lt;secret-key&gt; MINIO_REGION_NAME=&lt;region&gt;&quot;</pre><p>In the minio_disks section you have to specify each jail/node with the absolute path to the controlled disk (you have to specify multiple times a node if it has different drives under its control).<br> The minio_env section instead allows to specify multiple environment variables to configure properly the instances; I&#39;ve specified the essential variables but there are more in the <a href="https://docs.min.io/docs/minio-server-configuration-guide.html">documentation</a>.<br> Now we have to create a log file and give it appropriate ownership, the log file must be located in/var/log/minio.log and must belong to the user and group minio which will be created during the package installation; also be sure that the selected path for the Minio files belongs to the minio user and group.<br> After these configurations, we can spin up the service and configure the other jails/nodes through service minio start, it will wait for other services to spin up and then will be available.</p><h3>Accessing the cluster</h3><p>To access the cluster there are 2 possibilities:</p><ol><li>Direct connection to one node/jail IP address: http://&lt;dns-or-ip&gt;:&lt;port&gt;</li><li>Set up a load-balancer/reverse proxy (with SSL termination eventually).</li></ol><p>The first option is pretty simple, the Minio specified port must be forwarded or opened to the external world (these options could be also the default if you are working with multiple network-exposed nodes), but in my case, I’ve four jails inside the same hosts without any minio port exposed so I’ve opted in for the second solution.<br> I had previously settled up a nginx-plus jail (I will write an article on how to obtain a home/development plus license), and also settled up a jail with a CA (another future article) so the cluster is internally exposed with a TLS termination.<br> Regarding the nginx config file this is the result of the one that I’m using (with parametrization):</p><pre>upstream minio {                               <br>        zone minio 128k;                         <br>        server &lt;minio-1&gt;.&lt;internal-domain&gt;.&lt;internal-gtld&gt;:&lt;port&gt; <br>        server &lt;minio-2&gt;.&lt;internal-domain&gt;.&lt;internal-gtld&gt;:&lt;port&gt;;                       <br>        server &lt;minio-3&gt;.&lt;internal-domain&gt;.&lt;internal-gtld&gt;:&lt;port&gt;;<br>        server &lt;minio-4&gt;.&lt;internal-domain&gt;.&lt;internal-gtld&gt;:&lt;port&gt;  <br>}<br><br>server {                              <br>        listen 80;<br>        server_name &lt;ext-name&gt;.&lt;internal-domain&gt;.&lt;internal-gtld&gt;;<br>        return 301 https://$host$request_uri;<br>} <br><br>server{                                     <br>        listen 443 ssl http2; <br>        server_name &lt;ext-name&gt;.&lt;internal-domain&gt;.&lt;internal-gtld&gt;;<br>        ssl_certificate &lt;ca-obtained-cert-path&gt;;<br>        ssl_certificate_key &lt;ca-obtained-key-path&gt;;<br>        ssl_protocols TLSv1 TLSv1.1 TLSv1.2;<br>        ssl_ciphers &#39;EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH&#39;;<br>        ssl_prefer_server_ciphers on;<br>        ssl_session_cache shared:SSL:10m;<br>        ssl_dhparam &lt;path-to-nginx-dhparam&gt;;<br>        add_header Strict-Transport-Security &quot;max-age=31536000; includeSubdomains;&quot;;<br>        server_tokens off;<br>        add_header X-Frame-Options SAMEORIGIN;<br>        add_header X-Content-Type-Options nosniff;<br>        client_max_body_size 1000M; # Expanded body size<br>        location / {<br>                proxy_set_header Host $http_host;<br>                proxy_pass       http://minio;<br>                health_check uri=/minio/health/live interval=10 fails=3 passes=2; # This keyword is available only with nginx-plus<br>        }<br>}</pre><h3>Conclusion and Future Experiments</h3><p>The cluster is pretty much stable, I’m currently using it for internal backups of non-critical stuff (for the critical one I’ve my Synology NAS). For further experiments on my cluster, I’m curious about 3 different things:</p><ul><li>Multitenancy (<a href="https://docs.min.io/docs/multi-tenant-minio-deployment-guide.html">doc</a>)</li><li>Event publishing in the distributed mode (if possible)</li><li>Complex website hosting (I’m not a frontend developer XD)</li></ul><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=0ead26237556" width="1" height="1" alt="">
