---
layout: post
title: 'Using 1password as backup for application configurations: Rclone'
canonical_url: https://medium.com/@charliemaiors/using-1password-as-backup-for-application-configurations-rclone-dfc144bbd3c9?source=rss-7412c234d1fc------2
tag:
- automation
- playbook
- 1password
- ansible
- rclone
---

<h3>Introduction</h3><p>1password is the industry leader for secure content management, starting from passwords and log in to documents and secure notes. It offers a lot of client applications, like mobile for Android and iOS, Windows, and macOS and includes also a command line interface. Personally, my security relies completely on 1Password for passwords, software licenses, configuration, <a href="https://www.wikiwand.com/en/Multi-factor_authentication">2FA</a>, and everything tied to security for work and personal stuff. I was also interested in using the CLI on OS with a command line only (like my FreeBSD box) or Linux in order to have all my passwords and also have a secure way to retrieve my configuration with sensitive data. For instance, I use a lot <a href="https://rclone.org/">Rclone</a> as an all-cloud-sync client. Rclone is a rsync client (CLI only) for cloud storage, it allows to sync, and copy files between cloud storage and local machine or cloud-to-cloud; there is also a project called rclone-browser for users which always a GUI (personally I’m fine with the CLI). Rclone relies on a configuration file located typically in the user home directory, in this file the application saves (encrypted) all the configuration for each cloud storage (called remote); this file is perfectly portable between OSes and versions so it can be back upped in a safe place, for instance in 1password as a document.</p><h3>Automation</h3><p>Personally, for every new box that I deploy for development purposes, I use rclone to sync all produced data to object storage like swift or s3 or a personal cloud provider, I’ve also developed an <a href="https://galaxy.ansible.com/charliemaiors/rclone-ansible">ansible role</a> to automatically deploy rclone on new boxes (even macOS and windows) and manually copy my configuration file to the new installation.</p><p>Since when Ansible introduced the <a href="https://docs.ansible.com/ansible/latest/modules/onepassword_facts_module.html">onepassword_facts module</a> I&#39;ve finished the automation part regarding rclone.</p><p>Using delegation I’ve configured the ansible host machine with op binary properly configured to login on my 1Password account.</p><p>Below you can find the playbook used to automatically install and configure rclone:</p><pre>- name: Install rclone and configure it using 1password<br>  hosts: rclone<br>  become_method: sudo # Testing on a cloud VPS tipically the user has NOPASSWD for sudo<br>  vars:<br>    onepassword_rclone_config: &quot;doc-of-rclone-config&quot;<br>  roles:<br>    - { role: charliemaiors.rclone_ansible, become: true }<br>  tasks:<br>    - name: Take the rclone configuration<br>      onepassword_facts:<br>        search_terms: &quot;&quot;  # Assuming that you have already run op signin...<br>      delegate_to: localhost<br>      no_log: true<br>    - name: Get the location of the config file<br>      shell: &#39;rclone config file | grep -v &quot;Configuration file*&quot;&#39;<br>      args:<br>        executable: /bin/bash<br>      register: config_file<br>    - name: Check if rclone config directory exist<br>      stat:<br>        path: &quot;&quot;<br>      register: create_folder<br>    - name: Check if the rclone.conf file exist<br>      stat:<br>        path: &quot;&quot;<br>      register: touch_file<br>    - name: Create directory for rclone config if not exist<br>      file:<br>        path: &quot;&quot;<br>        state: directory<br>      when: not create_folder.stat.exists<br>    - name: Touch rclone file if the folder does not exist<br>      file:<br>        path: &quot;&quot;<br>        state: touch<br>      when: not touch_file.stat.exists<br>    - name: Create the rclone config<br>      copy:<br>        dest: &quot;&quot;<br>        content: &quot;&quot; # One Document<br>      with_dict: &quot;&quot;<br>      no_log: true # Otherwise the configuration will be printed to stdout</pre><p>Now we will examine the main parts of the playbook:</p><pre>roles:<br>    - { role: charliemaiors.rclone_ansible, become: true }</pre><p>This is pretty straightforward and uses a predefined role deployed on the ansible-galaxy to install rclone.</p><pre>- name: Take the rclone configuration<br>      onepassword_facts:<br>        search_terms: &quot;&quot;  # Assuming that you have already run op signin...<br>      delegate_to: localhost<br>      no_log: true</pre><p>This task will interrogate your one password account, relying on the op binary, for the rclone configuration document. The delegate_to: localhost delegate the task execution to the host machine using its resources (again the op binary above all). Using onepassword_facts without any login advice assumes that you have already logged in to 1Password CLI using op signin .... Of course, you want to avoid dumping all your rclone configuration on the log file and standard out so no_log is set to true.</p><pre>- name: Get the location of the config file<br>  shell: &#39;rclone config file | grep -v &quot;Configuration file*&quot;&#39;<br>  args:<br>    executable: /bin/bash<br>  register: config_file</pre><p>This snippet is an “hack” in order to retrieve the configuration file location, the grep part of the command must be substituted with Select-String -NotMatch &quot;Configuration file*&quot; on Windows and the task must be a win_shell.</p><pre>- name: Check if rclone config directory exist<br>  stat:<br>    path: &quot;&quot;<br>  register: create_folder<br>- name: Check if the rclone.conf file exist<br>  stat:<br>    path: &quot;&quot;<br>  register: touch_file<br>- name: Create directory for rclone config if not exist<br>  file:<br>    path: &quot;&quot;<br>    state: directory<br>  when: not create_folder.stat.exists<br>- name: Touch rclone file if the folder does not exist<br>  file:<br>    path: &quot;&quot;<br>    state: touch<br>  when: not touch_file.stat.exists</pre><p>These tasks create the necessary directory and configuration file if they don’t exist. The last task creates the rclone file empty because the copy module will fail if the file does not exist.</p><pre>- name: Create the rclone config<br>  copy:<br>    dest: &quot;&quot;<br>    content: &quot;&quot; # One Document<br>  with_dict: &quot;&quot;<br>  no_log: true # Otherwise the configuration will be printed to stdout</pre><p>The last task will copy the retrieved configuration to the rclone configuration file. The the onepassword_facts module will produce a dictionary using the search term as key and the tuple &lt;field: value&gt; as value, so to retrieve the value of the document you have to use &quot;&quot; as value for the content field of the copy module. It is obvious that the copy module will produce an output with the value of the dictionary so the no_log is mandatory.</p><h3>Conclusion</h3><p>This playbook can be easily declined to every service that stores configuration in a predefined place but must be taken into account the “overhead” of this procedure.</p><h3>Note</h3><p>The playbook is available on Github: <a href="https://github.com/charliemaiors/rclone-onepassword">https://github.com/charliemaiors/rclone-onepassword</a>.</p><p><em>Originally published at </em><a href="https://www.carlomaiorano.me/ansible/2019/03/13/rclone-onepassword.html"><em>https://www.carlomaiorano.me</em></a><em> on March 13, 2019.</em></p><img src="https://medium.com/_/stat?event=post.clientViewed&referrerSource=full_rss&postId=dfc144bbd3c9" width="1" height="1" alt="">
